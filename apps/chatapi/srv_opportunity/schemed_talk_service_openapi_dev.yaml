openapi: 3.0.1
info:
  title: Schemed Talk Service OpenAPI
  version: 0.2.0
  description: |
    The Schemed Talk Service executes declarative API orchestration workflows ("SchemedTalks").
    
    A SchemedTalk is a JSON document describing a sequence of typed steps such as:
    - HTTP API calls (GET / POST / PUT / PATCH)
    - AI requests (OpenAI)
    - Conditional logic
    - Memory extraction and reuse via JSONPath
    - Documentation-only steps for self-explaining workflows
    
    This API is designed for experimentation, debugging, and demonstration of API orchestration concepts.

    Helpful tools:
    - JSON Schema driven editor: https://json-editor.github.io/json-editor/
    - JSONPath evaluator: https://jsonpath.com/

servers:
  - url: "{server}:{port}"
    variables:
      server:
        default: http://www.sitems.org
      port:
        default: "16387"

paths:
  /schemed_talks:
    post:
      summary: Execute a SchemedTalk workflow
      description: |
        Executes a SchemedTalk workflow and returns the execution trace.
        
        This endpoint is optimized for the "happy path".
        In case of execution or type errors, the response may be concise.
        For detailed diagnostics, see `/schemed_talks_responses`.
      operationId: postSchemedTalks
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/SchemedTalk'
            examples:
              openai_demo_with_memory:
                summary: OpenAI + JSONPath + memory reuse demo
                description: |
                  Demonstrates:
                  - An OpenAI API call
                  - JSONPath-based extraction of generated content
                  - Storage into named memory
                  - Dynamic reuse of memorized data
                  - Self-documentation of the workflow
                value:
                  - type: SchemedTalkDoc
                    description: >
                      Demo SchemedTalk showing OpenAI call followed by
                      JSONPath-based memory extraction and reuse.
                  - type: OARequest
                    prompt: |
                      Explain in one short paragraph what microservices are
                      and why API orchestration matters.
                    prePromptFile: null
                  - type: Memorize
                    description: Memorize the OpenAI generated text
                    asWhat:
                      microservices_definition: "jsonpath:$.oaResponse"
                  - type: SchemedTalkDoc
                    description: "<?memory:microservices_definition?>"
                  - type: SchemedTalkDoc
                    description: >
                      What just happened: this workflow called the OpenAI API,
                      extracted the generated text using JSONPath, stored it
                      under a named memory key, and dynamically reused it in a
                      later step. This demonstrates declarative API orchestration,
                      data extraction, and memory-based reuse without imperative code.
      responses:
        "201":
          description: Execution result
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
        "400":
          description: Bad request or execution error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorPayload'

  /schemed_talks_responses:
    post:
      summary: Retrieve detailed execution diagnostics
      description: |
        This endpoint provides detailed diagnostics when a SchemedTalk execution fails.
        
        It is especially useful when:
        - A type conversion error occurs
        - A memory variable is missing or misnamed
        - A JSONPath expression is invalid
        - The main execution response is too concise
        
        Typical usage:
        - Execute `/schemed_talks`
        - If the response indicates a failure, inspect `/schemed_talks_responses`
          for detailed error context.
      operationId: postSchemedTalksResponses
      requestBody:
        content:
          '*/*':
            schema:
              description: Callback payload (internal use)
      responses:
        "201":
          description: Diagnostic information
          content:
            application/json:
              schema:
                type: object
        "400":
          description: Invalid diagnostic request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorPayload'

components:
  schemas:
    SchemedTalk:
      type: object
      description: |
        Base type for all SchemedTalk steps.
        Concrete behavior is determined by the `type` field.
      properties:
        type:
          type: string
        description:
          type: string
        talkScheme:
          type: array
          items:
            $ref: '#/components/schemas/SchemedTalk'

    ErrorPayload:
      type: object
      required:
        - timestamp
        - status
        - reason
        - message
        - path
        - method
      properties:
        timestamp:
          type: string
        status:
          type: integer
        reason:
          type: string
        message:
          type: string
        path:
          type: string
        method:
          type: string

